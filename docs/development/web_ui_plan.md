# Web UI 开发计划

本文档概述为 "One API 渠道批量更新工具" 开发 Web 用户界面的计划。

## 1. 目标

提供一个用户友好的 Web 界面，允许用户通过浏览器管理 One API 实例连接、配置批量操作规则、执行任务（更新、撤销、测试启用、跨站操作）并监控其状态和日志。

## 2. 技术选型 (建议)

*   **后端:** Python + FastAPI
    *   优点: 现代、高性能、与现有 `asyncio` 代码（`aiohttp`）集成良好、自动生成 API 文档。
*   **前端:** Vue.js 或 React
    *   优点: 主流现代框架，生态丰富，可选用成熟的 UI 组件库（如 Element Plus for Vue, Ant Design for React）加速开发。
*   **通信:**
    *   后端提供 RESTful API 供前端调用。
    *   对于长时间运行任务的状态更新和日志流，使用 WebSocket 或 Server-Sent Events (SSE)。

## 3. 核心功能模块

1.  **认证/授权:**
    *   实现简单的用户登录机制（例如基于用户名/密码或令牌）。
    *   确保只有授权用户可以访问管理界面和执行操作。
2.  **实例管理 (Connection Configs):**
    *   图形化界面展示 `connection_configs/` 目录下的连接配置。
    *   提供表单用于创建、编辑、删除连接配置文件 (`.yaml`)。
    *   在保存配置时进行后端验证（利用或实现 `robustness.md` 中规划的验证逻辑，检查 `site_url`, `api_token`, `api_type` 等）。
3.  **操作配置管理:**
    *   **单站点更新 (`update_config.yaml`):**
        *   提供结构化的表单界面来配置筛选器 (`filters`) 和更新规则 (`updates`)。
        *   支持选择不同的 `mode` (overwrite, append, remove, merge, delete_keys) 并根据字段类型动态调整可用选项。
        *   允许保存和加载不同的更新模板。
        *   (可选) 提供原始 YAML 编辑器作为补充。
    *   **跨站点操作 (`cross_site_config.yaml`):**
        *   提供界面配置 `action`、`source` (连接配置路径、筛选器)、`target` (连接配置路径、筛选器) 以及特定操作参数 (`copy_fields_params`, `compare_fields_params`)。
        *   (可选) 提供原始 YAML 编辑器作为补充。
4.  **任务执行与监控:**
    *   提供清晰的按钮来触发主要的操作：
        *   单站点: 查询、执行更新、撤销上次更新、测试并启用禁用渠道。
        *   跨站点: 查询源/目标、执行配置的操作 (`copy_fields`, `compare_fields`)。
    *   后端使用异步任务队列处理耗时操作。
    *   前端通过 WebSocket/SSE 实时显示：
        *   任务当前状态（排队中、运行中、已完成、失败）。
        *   任务执行日志流。
        *   模拟运行的结果预览。
    *   维护任务执行历史记录（包含触发时间、操作类型、目标配置、状态、结果摘要）。
5.  **日志查看:**
    *   提供界面按时间倒序列出 `runtime_data/logs/` 目录下的日志文件。
    *   允许用户选择并查看特定日志文件的内容。
6.  **脚本配置 (`script_config.yaml`):**
    *   提供界面编辑通用设置，如最大并发请求数 (`max_concurrent_requests`)、请求超时时间 (`request_timeout`)、API 分页大小 (`api_page_sizes`)。

## 4. 架构考虑

*   **核心逻辑重构与集成:**
    *   **关键步骤:** 将 `channel_manager_lib` (特别是 `single_site_handler.py`, `cross_site_handler.py`, `config_utils.py`, `filtering_utils.py` 等) 中的核心业务逻辑（如配置加载、渠道筛选、更新 payload 计算、API 调用封装、撤销数据处理等）重构成更独立的、可被 FastAPI 直接调用的函数或类库。
    *   FastAPI 后端**不**应该通过 `subprocess` 调用 `run_tool.sh` 或 `main_tool.py`，而是直接导入和使用重构后的库。这能提供更好的性能、错误处理和状态控制。
    *   **重要说明:** 此重构旨在创建共享的核心库。现有的命令行/交互式工具 (`main_tool.py`) 也将更新为调用此共享库，从而确保 Web UI 和命令行工具可以**共存**并保持功能一致性，而非取代关系。
*   **异步任务处理:**
    *   使用 Celery (配合 Redis/RabbitMQ) 或 FastAPI 内置的 `BackgroundTasks` 来处理可能耗时较长的 API 调用和处理流程（例如批量更新、测试大量渠道）。
    *   任务状态和日志通过 WebSocket/SSE 或数据库/缓存反馈给前端。
*   **Docker 支持 (推荐):**
    *   强烈建议使用 Docker 和 Docker Compose 来管理开发环境和简化部署。
    *   **开发:** 提供 `Dockerfile` 和 `docker-compose.yml` 来创建一致的本地开发环境（包括后端、前端开发服务器、可能的 Redis/Celery 等）。
    *   **部署:** 提供优化的生产 `Dockerfile` 和 `docker-compose.prod.yml` 来容器化部署 FastAPI 后端、Nginx（用于服务前端静态文件）以及其他依赖服务。
    *   优点：确保环境一致性、简化依赖管理、标准化部署流程、提供扩展基础。
*   **状态管理:** 配置文件的读取和写入需要加锁或使用其他机制来避免并发访问冲突。任务状态需要持久化存储（例如数据库或文件）。

## 5. 开发阶段规划 (建议)

1.  **阶段 1: 基础架构与实例管理 (预计工作量: 中)**
    *   [后端] 搭建 FastAPI 项目结构，配置依赖。
    *   [后端] 实现基础用户认证 API。
    *   [**核心**] **重构 `channel_manager_lib` 核心逻辑为可直接调用的库。**
    *   [后端] 实现连接配置管理的 CRUD API，集成配置验证逻辑。
    *   [前端] 搭建前端项目 (Vue/React)，配置路由。
    *   [前端] 实现登录页面和连接配置列表/编辑界面。
2.  **阶段 2: 核心操作流程 - 单站点 (预计工作量: 大)**
    *   [后端] 实现 `update_config.yaml` 的解析、验证和保存 API。
    *   [后端] 实现触发“单站点更新”和“测试并启用”的 API，调用重构后的库函数。
    *   [后端] 集成异步任务队列 (如 `BackgroundTasks` 或 Celery)。
    *   [后端] 实现 WebSocket/SSE 端点用于推送任务状态和日志。
    *   [前端] 实现 `update_config.yaml` 的编辑界面。
    *   [前端] 实现触发单站点任务的按钮。
    *   [前端] 实现任务状态显示和实时日志查看组件。
3.  **阶段 3: 完善其他功能 (预计工作量: 大)**
    *   [后端] 实现“撤销”操作的 API。
    *   [后端] 实现 `cross_site_config.yaml` 的解析、验证和保存 API。
    *   [后端] 实现触发“跨站点操作”的 API。
    *   [后端] 实现日志文件列表和内容获取 API。
    *   [后端] 实现 `script_config.yaml` 的读取和保存 API。
    *   [前端] 实现撤销操作界面。
    *   [前端] 实现跨站点操作配置界面和触发按钮。
    *   [前端] 实现日志查看界面。
    *   [前端] 实现脚本配置编辑界面。
4.  **阶段 4: 测试、优化与部署 (预计工作量: 中)**
    *   [后端] 编写 API 的单元测试和集成测试。
    *   [前后端] 进行全面的功能测试和用户体验 (UI/UX) 优化。
    *   [运维] 准备部署方案，例如使用 Docker 和 Docker Compose 将前后端容器化部署。
    *   [文档] 编写 Web UI 的使用说明。

## 6. 风险与挑战

*   **代码重构:** 将现有命令行逻辑重构为可供 Web 后端调用的库是关键且可能耗时的一步。
*   **异步处理复杂性:** 正确管理异步任务、状态更新和错误处理需要仔细设计。
*   **前后端开发投入:** 需要同时投入前后端开发资源。
*   **用户体验设计:** 设计一个直观易用的界面需要投入思考。